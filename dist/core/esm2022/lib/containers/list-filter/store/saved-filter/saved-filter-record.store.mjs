/**
 * SuiteCRM is a customer relationship management program developed by SalesAgility Ltd.
 * Copyright (C) 2021 SalesAgility Ltd.
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Affero General Public License version 3 as published by the
 * Free Software Foundation with the addition of the following permission added
 * to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK
 * IN WHICH THE COPYRIGHT IS OWNED BY SALESAGILITY, SALESAGILITY DISCLAIMS THE
 * WARRANTY OF NON INFRINGEMENT OF THIRD PARTY RIGHTS.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * In accordance with Section 7(b) of the GNU Affero General Public License
 * version 3, these Appropriate Legal Notices must retain the display of the
 * "Supercharged by SuiteCRM" logo. If the display of the logos is not reasonably
 * feasible for technical reasons, the Appropriate Legal Notices must display
 * the words "Supercharged by SuiteCRM".
 */
import { deepClone } from '../../../../common/utils/object-utils';
import { BehaviorSubject, of } from 'rxjs';
import { shareReplay, tap } from 'rxjs/operators';
import { RecordStore } from '../../../../store/record/record.store';
import { UntypedFormGroup } from '@angular/forms';
import { signal } from "@angular/core";
const initialState = {
    id: '',
    type: '',
    module: '',
    attributes: {}
};
export class SavedFilterRecordStore extends RecordStore {
    constructor(definitions$, metadata$, recordSaveGQL, recordFetchGQL, message, recordManager, recordMappers, fieldManager, language) {
        super(definitions$, metadata$, recordSaveGQL, recordFetchGQL, message, recordManager, recordMappers);
        this.definitions$ = definitions$;
        this.metadata$ = metadata$;
        this.recordSaveGQL = recordSaveGQL;
        this.recordFetchGQL = recordFetchGQL;
        this.message = message;
        this.recordManager = recordManager;
        this.recordMappers = recordMappers;
        this.fieldManager = fieldManager;
        this.language = language;
        this.internalState = deepClone(initialState);
        this.stagingState = deepClone(initialState);
        this.store = new BehaviorSubject(this.internalState);
        this.staging = new BehaviorSubject(this.stagingState);
        this.searchFields = {};
        this.listColumns = [];
        this.state$ = this.store.asObservable().pipe(tap(record => {
            this.updateStaging(record);
        }));
        this.staging$ = this.staging.asObservable();
    }
    /**
     * Get search fields metadata
     * @returns SearchMetaFieldMap
     */
    getSearchFields() {
        return this.searchFields;
    }
    /**
     * Set search fields metadata
     * @param {object} searchFields SearchMetaFieldMap
     */
    setSearchFields(searchFields) {
        this.searchFields = searchFields;
    }
    /**
     * Get list fields metadata
     * @returns SearchMetaFieldMap
     */
    getListColumns() {
        return this.listColumns;
    }
    /**
     * Set list fields metadata
     * @param {object} listColumns SearchMetaFieldMap
     */
    setListColumns(listColumns) {
        this.listColumns = listColumns;
    }
    /**
     * Get record
     *
     * @returns {object} Record
     */
    getBaseRecord() {
        if (!this.stagingState) {
            return null;
        }
        this.mapStagingFields();
        return deepClone({
            id: this.stagingState.id,
            type: this.stagingState.type,
            module: this.stagingState.module,
            key: this.stagingState.key,
            searchModule: this.stagingState.searchModule,
            criteria: this.stagingState.criteria,
            attributes: this.stagingState.attributes,
        });
    }
    /**
     * Extract base record
     *
     * @returns {object} Record
     */
    extractBaseRecord(record) {
        if (!record) {
            return null;
        }
        let criteria = record.criteria ?? {};
        if (Array.isArray(criteria) && !criteria.length) {
            criteria = {};
        }
        return deepClone({
            id: record.id,
            type: record.type,
            module: record.module,
            key: record.key,
            searchModule: record.searchModule,
            criteria: criteria,
            attributes: record.attributes,
        });
    }
    /**
     * Init record fields
     *
     * @param {object} record Record
     */
    initRecord(record) {
        if (this.metadata) {
            record.metadata = this.metadata;
        }
        if (!record?.validationTriggered) {
            record.validationTriggered = signal(false);
        }
        record.attributes = record.attributes || {};
        record.attributes.search_module = record.searchModule;
        const filters = record?.attributes?.contents?.filters ?? {};
        record.attributes.contents = record.attributes.contents || { filters: {} };
        if (Array.isArray(filters) && !filters.length) {
            record.attributes.contents.filters = {};
        }
        else {
            record.attributes.contents.filters = filters;
        }
        record.criteria = this.getCriteria(record);
        this.initCriteriaFields(record, this.getSearchFields());
        if (record.module && this.definitions && this.definitions.length > 0) {
            record.fields = this.recordManager.initFields(record, this.definitions);
        }
        this.initOrderByOptions(record);
    }
    /**
     * Init Order by options using list view columns set as default
     * @param record
     */
    initOrderByOptions(record) {
        if (!record.fields || !record.fields.orderBy) {
            return;
        }
        record.fields.orderBy.metadata = record.fields.orderBy.metadata || {};
        const options = [];
        this.getListColumns().forEach(column => {
            if (!column.default || column.default !== true) {
                return;
            }
            const labelKey = column.label || column.fieldDefinition.vname || '';
            const label = this.language.getFieldLabel(labelKey, record.searchModule);
            options.push({
                value: column.fieldDefinition.name || column.name,
                label
            });
        });
        record.fields.orderBy.metadata.options$ = of(options).pipe(shareReplay());
    }
    /**
     * Get criteria from filter
     * @param filter
     */
    getCriteria(filter) {
        if (!filter || !filter.criteria) {
            return { filters: {} };
        }
        if (!filter.criteria.filters) {
            return { ...filter.criteria, filters: {} };
        }
        if (Array.isArray(filter.criteria.filters) && !filter.criteria.filters.length) {
            return { ...filter.criteria, filters: {} };
        }
        return deepClone(filter.criteria);
    }
    /**
     * Initialize criteria fields
     *
     * @param {object} record to use
     * @param {object} searchFields to use
     */
    initCriteriaFields(record, searchFields) {
        record.criteriaFields = record.criteriaFields || {};
        if (!record.criteriaFormGroup) {
            record.criteriaFormGroup = new UntypedFormGroup({});
        }
        if (!searchFields) {
            return;
        }
        Object.keys(searchFields).forEach(key => {
            this.buildField(record, searchFields[key]);
        });
    }
    /**
     * Build filter field according to Field interface
     *
     * @param {object} record SavedFilter
     * @param {object} fieldMeta to use
     */
    buildField(record, fieldMeta) {
        const fieldName = fieldMeta.name;
        const type = fieldMeta.type;
        const definition = {
            name: fieldMeta.name,
            label: fieldMeta.label,
            vardefBased: fieldMeta?.vardefBased ?? false,
            readonly: fieldMeta?.readonly ?? false,
            display: fieldMeta?.display ?? 'default',
            type,
            fieldDefinition: {}
        };
        if (fieldMeta.fieldDefinition) {
            definition.fieldDefinition = fieldMeta.fieldDefinition;
        }
        if (type === 'bool' || type === 'boolean') {
            definition.fieldDefinition.options = 'dom_int_bool';
        }
        this.fieldManager.addFilterField(record, definition, this.language);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2F2ZWQtZmlsdGVyLXJlY29yZC5zdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2NvcmUvYXBwL2NvcmUvc3JjL2xpYi9jb250YWluZXJzL2xpc3QtZmlsdGVyL3N0b3JlL3NhdmVkLWZpbHRlci9zYXZlZC1maWx0ZXItcmVjb3JkLnN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F3Qkc7QUFFSCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sdUNBQXVDLENBQUM7QUFPaEUsT0FBTyxFQUFDLGVBQWUsRUFBYyxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDckQsT0FBTyxFQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sdUNBQXVDLENBQUM7QUFFbEUsT0FBTyxFQUFDLGdCQUFnQixFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFPaEQsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUdyQyxNQUFNLFlBQVksR0FBRztJQUNqQixFQUFFLEVBQUUsRUFBRTtJQUNOLElBQUksRUFBRSxFQUFFO0lBQ1IsTUFBTSxFQUFFLEVBQUU7SUFDVixVQUFVLEVBQUUsRUFBRTtDQUNQLENBQUM7QUFFWixNQUFNLE9BQU8sc0JBQXVCLFNBQVEsV0FBVztJQVduRCxZQUNjLFlBQStDLEVBQy9DLFNBQWdDLEVBQ2hDLGFBQTRCLEVBQzVCLGNBQThCLEVBQzlCLE9BQXVCLEVBQ3ZCLGFBQTRCLEVBQzVCLGFBQW1DLEVBQ25DLFlBQTBCLEVBQzFCLFFBQXVCO1FBRWpDLEtBQUssQ0FDRCxZQUFZLEVBQ1osU0FBUyxFQUNULGFBQWEsRUFDYixjQUFjLEVBQ2QsT0FBTyxFQUNQLGFBQWEsRUFDYixhQUFhLENBQ2hCLENBQUM7UUFsQlEsaUJBQVksR0FBWixZQUFZ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ZUFBZSxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUM7UUFDeEQsQ0FBQztRQUVELElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRXhFLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU3VpdGVDUk0gaXMgYSBjdXN0b21lciByZWxhdGlvbnNoaXAgbWFuYWdlbWVudCBwcm9ncmFtIGRldmVsb3BlZCBieSBTYWxlc0FnaWxpdHkgTHRkLlxuICogQ29weXJpZ2h0IChDKSAyMDIxIFNhbGVzQWdpbGl0eSBMdGQuXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkgaXQgdW5kZXJcbiAqIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIHZlcnNpb24gMyBhcyBwdWJsaXNoZWQgYnkgdGhlXG4gKiBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24gd2l0aCB0aGUgYWRkaXRpb24gb2YgdGhlIGZvbGxvd2luZyBwZXJtaXNzaW9uIGFkZGVkXG4gKiB0byBTZWN0aW9uIDE1IGFzIHBlcm1pdHRlZCBpbiBTZWN0aW9uIDcoYSk6IEZPUiBBTlkgUEFSVCBPRiBUSEUgQ09WRVJFRCBXT1JLXG4gKiBJTiBXSElDSCBUSEUgQ09QWVJJR0hUIElTIE9XTkVEIEJZIFNBTEVTQUdJTElUWSwgU0FMRVNBR0lMSVRZIERJU0NMQUlNUyBUSEVcbiAqIFdBUlJBTlRZIE9GIE5PTiBJTkZSSU5HRU1FTlQgT0YgVEhJUkQgUEFSVFkgUklHSFRTLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLCBidXQgV0lUSE9VVFxuICogQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1NcbiAqIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmVcbiAqIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqXG4gKiBJbiBhY2NvcmRhbmNlIHdpdGggU2VjdGlvbiA3KGIpIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIHZlcnNpb24gMywgdGhlc2UgQXBwcm9wcmlhdGUgTGVnYWwgTm90aWNlcyBtdXN0IHJldGFpbiB0aGUgZGlzcGxheSBvZiB0aGVcbiAqIFwiU3VwZXJjaGFyZ2VkIGJ5IFN1aXRlQ1JNXCIgbG9nby4gSWYgdGhlIGRpc3BsYXkgb2YgdGhlIGxvZ29zIGlzIG5vdCByZWFzb25hYmx5XG4gKiBmZWFzaWJsZSBmb3IgdGVjaG5pY2FsIHJlYXNvbnMsIHRoZSBBcHByb3ByaWF0ZSBMZWdhbCBOb3RpY2VzIG11c3QgZGlzcGxheVxuICogdGhlIHdvcmRzIFwiU3VwZXJjaGFyZ2VkIGJ5IFN1aXRlQ1JNXCIuXG4gKi9cblxuaW1wb3J0IHtkZWVwQ2xvbmV9IGZyb20gJy4uLy4uLy4uLy4uL2NvbW1vbi91dGlscy9vYmplY3QtdXRpbHMnO1xuaW1wb3J0IHtDb2x1bW5EZWZpbml0aW9uLCBTZWFyY2hNZXRhRmllbGQsIFNlYXJjaE1ldGFGaWVsZE1hcH0gZnJvbSAnLi4vLi4vLi4vLi4vY29tbW9uL21ldGFkYXRhL2xpc3QubWV0YWRhdGEubW9kZWwnO1xuaW1wb3J0IHtGaWVsZE1hcCwgRmllbGRNZXRhZGF0YSwgT3B0aW9ufSBmcm9tICcuLi8uLi8uLi8uLi9jb21tb24vcmVjb3JkL2ZpZWxkLm1vZGVsJztcbmltcG9ydCB7UmVjb3JkfSBmcm9tICcuLi8uLi8uLi8uLi9jb21tb24vcmVjb3JkL3JlY29yZC5tb2RlbCc7XG5pbXBvcnQge1JlY29yZE1hcHBlclJlZ2lzdHJ5fSBmcm9tICcuLi8uLi8uLi8uLi9jb21tb24vcmVjb3JkL3JlY29yZC1tYXBwZXJzL3JlY29yZC1tYXBwZXIucmVnaXN0cnknO1xuaW1wb3J0IHtTZWFyY2hDcml0ZXJpYX0gZnJvbSAnLi4vLi4vLi4vLi4vY29tbW9uL3ZpZXdzL2xpc3Qvc2VhcmNoLWNyaXRlcmlhLm1vZGVsJztcbmltcG9ydCB7Vmlld0ZpZWxkRGVmaW5pdGlvbn0gZnJvbSAnLi4vLi4vLi4vLi4vY29tbW9uL21ldGFkYXRhL21ldGFkYXRhLm1vZGVsJztcbmltcG9ydCB7QmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBvZn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge3NoYXJlUmVwbGF5LCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7UmVjb3JkU3RvcmV9IGZyb20gJy4uLy4uLy4uLy4uL3N0b3JlL3JlY29yZC9yZWNvcmQuc3RvcmUnO1xuaW1wb3J0IHtTYXZlZEZpbHRlciwgU2F2ZWRGaWx0ZXJBdHRyaWJ1dGVNYXB9IGZyb20gJy4uLy4uLy4uLy4uL3N0b3JlL3NhdmVkLWZpbHRlcnMvc2F2ZWQtZmlsdGVyLm1vZGVsJztcbmltcG9ydCB7VW50eXBlZEZvcm1Hcm91cH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtSZWNvcmRTYXZlR1FMfSBmcm9tICcuLi8uLi8uLi8uLi9zdG9yZS9yZWNvcmQvZ3JhcGhxbC9hcGkucmVjb3JkLnNhdmUnO1xuaW1wb3J0IHtNZXNzYWdlU2VydmljZX0gZnJvbSAnLi4vLi4vLi4vLi4vc2VydmljZXMvbWVzc2FnZS9tZXNzYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHtSZWNvcmRGZXRjaEdRTH0gZnJvbSAnLi4vLi4vLi4vLi4vc3RvcmUvcmVjb3JkL2dyYXBocWwvYXBpLnJlY29yZC5nZXQnO1xuaW1wb3J0IHtSZWNvcmRNYW5hZ2VyfSBmcm9tICcuLi8uLi8uLi8uLi9zZXJ2aWNlcy9yZWNvcmQvcmVjb3JkLm1hbmFnZXInO1xuaW1wb3J0IHtGaWVsZE1hbmFnZXJ9IGZyb20gJy4uLy4uLy4uLy4uL3NlcnZpY2VzL3JlY29yZC9maWVsZC9maWVsZC5tYW5hZ2VyJztcbmltcG9ydCB7TGFuZ3VhZ2VTdG9yZX0gZnJvbSAnLi4vLi4vLi4vLi4vc3RvcmUvbGFuZ3VhZ2UvbGFuZ3VhZ2Uuc3RvcmUnO1xuaW1wb3J0IHtzaWduYWx9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQge09iamVjdE1hcH0gZnJvbSBcIi4uLy4uLy4uLy4uL2NvbW1vbi90eXBlcy9vYmplY3QtbWFwXCI7XG5cbmNvbnN0IGluaXRpYWxTdGF0ZSA9IHtcbiAgICBpZDogJycsXG4gICAgdHlwZTogJycsXG4gICAgbW9kdWxlOiAnJyxcbiAgICBhdHRyaWJ1dGVzOiB7fVxufSBhcyBSZWNvcmQ7XG5cbmV4cG9ydCBjbGFzcyBTYXZlZEZpbHRlclJlY29yZFN0b3JlIGV4dGVuZHMgUmVjb3JkU3RvcmUge1xuXG4gICAgc3RhdGUkOiBPYnNlcnZhYmxlPFNhdmVkRmlsdGVyPjtcbiAgICBzdGFnaW5nJDogT2JzZXJ2YWJsZTxTYXZlZEZpbHRlcj47XG4gICAgcHJvdGVjdGVkIGludGVybmFsU3RhdGU6IFNhdmVkRmlsdGVyID0gZGVlcENsb25lKGluaXRpYWxTdGF0ZSk7XG4gICAgcHJvdGVjdGVkIHN0YWdpbmdTdGF0ZTogU2F2ZWRGaWx0ZXIgPSBkZWVwQ2xvbmUoaW5pdGlhbFN0YXRlKTtcbiAgICBwcm90ZWN0ZWQgc3RvcmUgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFNhdmVkRmlsdGVyPih0aGlzLmludGVybmFsU3RhdGUpO1xuICAgIHByb3RlY3RlZCBzdGFnaW5nID0gbmV3IEJlaGF2aW9yU3ViamVjdDxTYXZlZEZpbHRlcj4odGhpcy5zdGFnaW5nU3RhdGUpO1xuICAgIHByb3RlY3RlZCBzZWFyY2hGaWVsZHM6IFNlYXJjaE1ldGFGaWVsZE1hcCA9IHt9O1xuICAgIHByb3RlY3RlZCBsaXN0Q29sdW1uczogQ29sdW1uRGVmaW5pdGlvbltdID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIGRlZmluaXRpb25zJDogT2JzZXJ2YWJsZTxWaWV3RmllbGREZWZpbml0aW9uW10+LFxuICAgICAgICBwcm90ZWN0ZWQgbWV0YWRhdGEkOiBPYnNlcnZhYmxlPE9iamVjdE1hcD4sXG4gICAgICAgIHByb3RlY3RlZCByZWNvcmRTYXZlR1FMOiBSZWNvcmRTYXZlR1FMLFxuICAgICAgICBwcm90ZWN0ZWQgcmVjb3JkRmV0Y2hHUUw6IFJlY29yZEZldGNoR1FMLFxuICAgICAgICBwcm90ZWN0ZWQgbWVzc2FnZTogTWVzc2FnZVNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCByZWNvcmRNYW5hZ2VyOiBSZWNvcmRNYW5hZ2VyLFxuICAgICAgICBwcm90ZWN0ZWQgcmVjb3JkTWFwcGVyczogUmVjb3JkTWFwcGVyUmVnaXN0cnksXG4gICAgICAgIHByb3RlY3RlZCBmaWVsZE1hbmFnZXI6IEZpZWxkTWFuYWdlcixcbiAgICAgICAgcHJvdGVjdGVkIGxhbmd1YWdlOiBMYW5ndWFnZVN0b3JlXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKFxuICAgICAgICAgICAgZGVmaW5pdGlvbnMkLFxuICAgICAgICAgICAgbWV0YWRhdGEkLFxuICAgICAgICAgICAgcmVjb3JkU2F2ZUdRTCxcbiAgICAgICAgICAgIHJlY29yZEZldGNoR1FMLFxuICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgIHJlY29yZE1hbmFnZXIsXG4gICAgICAgICAgICByZWNvcmRNYXBwZXJzXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSQgPSB0aGlzLnN0b3JlLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICAgICAgICB0YXAocmVjb3JkID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YWdpbmcocmVjb3JkKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuc3RhZ2luZyQgPSB0aGlzLnN0YWdpbmcuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHNlYXJjaCBmaWVsZHMgbWV0YWRhdGFcbiAgICAgKiBAcmV0dXJucyBTZWFyY2hNZXRhRmllbGRNYXBcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0U2VhcmNoRmllbGRzKCk6IFNlYXJjaE1ldGFGaWVsZE1hcCB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlYXJjaEZpZWxkcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXQgc2VhcmNoIGZpZWxkcyBtZXRhZGF0YVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzZWFyY2hGaWVsZHMgU2VhcmNoTWV0YUZpZWxkTWFwXG4gICAgICovXG4gICAgcHVibGljIHNldFNlYXJjaEZpZWxkcyhzZWFyY2hGaWVsZHM6IFNlYXJjaE1ldGFGaWVsZE1hcCk6IHZvaWQge1xuICAgICAgICB0aGlzLnNlYXJjaEZpZWxkcyA9IHNlYXJjaEZpZWxkcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgbGlzdCBmaWVsZHMgbWV0YWRhdGFcbiAgICAgKiBAcmV0dXJucyBTZWFyY2hNZXRhRmllbGRNYXBcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0TGlzdENvbHVtbnMoKTogQ29sdW1uRGVmaW5pdGlvbltdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGlzdENvbHVtbnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0IGxpc3QgZmllbGRzIG1ldGFkYXRhXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGxpc3RDb2x1bW5zIFNlYXJjaE1ldGFGaWVsZE1hcFxuICAgICAqL1xuICAgIHB1YmxpYyBzZXRMaXN0Q29sdW1ucyhsaXN0Q29sdW1uczogQ29sdW1uRGVmaW5pdGlvbltdKTogdm9pZCB7XG4gICAgICAgIHRoaXMubGlzdENvbHVtbnMgPSBsaXN0Q29sdW1ucztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgcmVjb3JkXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBSZWNvcmRcbiAgICAgKi9cbiAgICBnZXRCYXNlUmVjb3JkKCk6IFNhdmVkRmlsdGVyIHtcbiAgICAgICAgaWYgKCF0aGlzLnN0YWdpbmdTdGF0ZSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm1hcFN0YWdpbmdGaWVsZHMoKTtcblxuICAgICAgICByZXR1cm4gZGVlcENsb25lKHtcbiAgICAgICAgICAgIGlkOiB0aGlzLnN0YWdpbmdTdGF0ZS5pZCxcbiAgICAgICAgICAgIHR5cGU6IHRoaXMuc3RhZ2luZ1N0YXRlLnR5cGUsXG4gICAgICAgICAgICBtb2R1bGU6IHRoaXMuc3RhZ2luZ1N0YXRlLm1vZHVsZSxcbiAgICAgICAgICAgIGtleTogdGhpcy5zdGFnaW5nU3RhdGUua2V5LFxuICAgICAgICAgICAgc2VhcmNoTW9kdWxlOiB0aGlzLnN0YWdpbmdTdGF0ZS5zZWFyY2hNb2R1bGUsXG4gICAgICAgICAgICBjcml0ZXJpYTogdGhpcy5zdGFnaW5nU3RhdGUuY3JpdGVyaWEsXG4gICAgICAgICAgICBhdHRyaWJ1dGVzOiB0aGlzLnN0YWdpbmdTdGF0ZS5hdHRyaWJ1dGVzLFxuICAgICAgICB9IGFzIFNhdmVkRmlsdGVyKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBFeHRyYWN0IGJhc2UgcmVjb3JkXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBSZWNvcmRcbiAgICAgKi9cbiAgICBleHRyYWN0QmFzZVJlY29yZChyZWNvcmQ6IFNhdmVkRmlsdGVyKTogUmVjb3JkIHtcbiAgICAgICAgaWYgKCFyZWNvcmQpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNyaXRlcmlhID0gcmVjb3JkLmNyaXRlcmlhID8/IHt9O1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjcml0ZXJpYSkgJiYgIWNyaXRlcmlhLmxlbmd0aCkge1xuICAgICAgICAgICAgY3JpdGVyaWEgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBkZWVwQ2xvbmUoe1xuICAgICAgICAgICAgaWQ6IHJlY29yZC5pZCxcbiAgICAgICAgICAgIHR5cGU6IHJlY29yZC50eXBlLFxuICAgICAgICAgICAgbW9kdWxlOiByZWNvcmQubW9kdWxlLFxuICAgICAgICAgICAga2V5OiByZWNvcmQua2V5LFxuICAgICAgICAgICAgc2VhcmNoTW9kdWxlOiByZWNvcmQuc2VhcmNoTW9kdWxlLFxuICAgICAgICAgICAgY3JpdGVyaWE6IGNyaXRlcmlhLFxuICAgICAgICAgICAgYXR0cmlidXRlczogcmVjb3JkLmF0dHJpYnV0ZXMsXG4gICAgICAgIH0gYXMgU2F2ZWRGaWx0ZXIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluaXQgcmVjb3JkIGZpZWxkc1xuICAgICAqXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlY29yZCBSZWNvcmRcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgaW5pdFJlY29yZChyZWNvcmQ6IFNhdmVkRmlsdGVyKTogdm9pZCB7XG5cbiAgICAgICAgaWYgKHRoaXMubWV0YWRhdGEpIHtcbiAgICAgICAgICAgIHJlY29yZC5tZXRhZGF0YSA9IHRoaXMubWV0YWRhdGE7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXJlY29yZD8udmFsaWRhdGlvblRyaWdnZXJlZCkge1xuICAgICAgICAgICAgcmVjb3JkLnZhbGlkYXRpb25UcmlnZ2VyZWQgPSBzaWduYWwoZmFsc2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZXMgPSByZWNvcmQuYXR0cmlidXRlcyB8fCB7fSBhcyBTYXZlZEZpbHRlckF0dHJpYnV0ZU1hcDtcbiAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZXMuc2VhcmNoX21vZHVsZSA9IHJlY29yZC5zZWFyY2hNb2R1bGU7XG4gICAgICAgIGNvbnN0IGZpbHRlcnMgPSByZWNvcmQ/LmF0dHJpYnV0ZXM/LmNvbnRlbnRzPy5maWx0ZXJzID8/IHt9O1xuICAgICAgICByZWNvcmQuYXR0cmlidXRlcy5jb250ZW50cyA9IHJlY29yZC5hdHRyaWJ1dGVzLmNvbnRlbnRzIHx8IHtmaWx0ZXJzOiB7fX0gYXMgU2VhcmNoQ3JpdGVyaWE7XG5cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZmlsdGVycykgJiYgIWZpbHRlcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZWNvcmQuYXR0cmlidXRlcy5jb250ZW50cy5maWx0ZXJzID0ge307XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWNvcmQuYXR0cmlidXRlcy5jb250ZW50cy5maWx0ZXJzID0gZmlsdGVycztcbiAgICAgICAgfVxuXG4gICAgICAgIHJlY29yZC5jcml0ZXJpYSA9IHRoaXMuZ2V0Q3JpdGVyaWEocmVjb3JkKTtcblxuICAgICAgICB0aGlzLmluaXRDcml0ZXJpYUZpZWxkcyhyZWNvcmQsIHRoaXMuZ2V0U2VhcmNoRmllbGRzKCkpO1xuXG4gICAgICAgIGlmIChyZWNvcmQubW9kdWxlICYmIHRoaXMuZGVmaW5pdGlvbnMgJiYgdGhpcy5kZWZpbml0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZWNvcmQuZmllbGRzID0gdGhpcy5yZWNvcmRNYW5hZ2VyLmluaXRGaWVsZHMocmVjb3JkLCB0aGlzLmRlZmluaXRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuaW5pdE9yZGVyQnlPcHRpb25zKHJlY29yZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5pdCBPcmRlciBieSBvcHRpb25zIHVzaW5nIGxpc3QgdmlldyBjb2x1bW5zIHNldCBhcyBkZWZhdWx0XG4gICAgICogQHBhcmFtIHJlY29yZFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBpbml0T3JkZXJCeU9wdGlvbnMocmVjb3JkOiBTYXZlZEZpbHRlcik6IHZvaWQge1xuICAgICAgICBpZiAoIXJlY29yZC5maWVsZHMgfHwgIXJlY29yZC5maWVsZHMub3JkZXJCeSkge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICByZWNvcmQuZmllbGRzLm9yZGVyQnkubWV0YWRhdGEgPSByZWNvcmQuZmllbGRzLm9yZGVyQnkubWV0YWRhdGEgfHwge30gYXMgRmllbGRNZXRhZGF0YTtcblxuICAgICAgICBjb25zdCBvcHRpb25zID0gW10gYXMgT3B0aW9uW107XG4gICAgICAgIHRoaXMuZ2V0TGlzdENvbHVtbnMoKS5mb3JFYWNoKGNvbHVtbiA9PiB7XG5cbiAgICAgICAgICAgIGlmICghY29sdW1uLmRlZmF1bHQgfHwgY29sdW1uLmRlZmF1bHQgIT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGxhYmVsS2V5ID0gY29sdW1uLmxhYmVsIHx8IGNvbHVtbi5maWVsZERlZmluaXRpb24udm5hbWUgfHwgJyc7XG4gICAgICAgICAgICBjb25zdCBsYWJlbCA9IHRoaXMubGFuZ3VhZ2UuZ2V0RmllbGRMYWJlbChsYWJlbEtleSwgcmVjb3JkLnNlYXJjaE1vZHVsZSk7XG5cbiAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7XG4gICAgICAgICAgICAgICAgdmFsdWU6IGNvbHVtbi5maWVsZERlZmluaXRpb24ubmFtZSB8fCBjb2x1bW4ubmFtZSxcbiAgICAgICAgICAgICAgICBsYWJlbFxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVjb3JkLmZpZWxkcy5vcmRlckJ5Lm1ldGFkYXRhLm9wdGlvbnMkID0gb2Yob3B0aW9ucykucGlwZShzaGFyZVJlcGxheSgpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY3JpdGVyaWEgZnJvbSBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gZmlsdGVyXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGdldENyaXRlcmlhKGZpbHRlcjogU2F2ZWRGaWx0ZXIpOiBTZWFyY2hDcml0ZXJpYSB7XG5cbiAgICAgICAgaWYgKCFmaWx0ZXIgfHwgIWZpbHRlci5jcml0ZXJpYSkge1xuICAgICAgICAgICAgcmV0dXJuIHtmaWx0ZXJzOiB7fX07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWZpbHRlci5jcml0ZXJpYS5maWx0ZXJzKSB7XG4gICAgICAgICAgICByZXR1cm4gey4uLmZpbHRlci5jcml0ZXJpYSwgZmlsdGVyczoge319O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZmlsdGVyLmNyaXRlcmlhLmZpbHRlcnMpICYmICFmaWx0ZXIuY3JpdGVyaWEuZmlsdGVycy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiB7Li4uZmlsdGVyLmNyaXRlcmlhLCBmaWx0ZXJzOiB7fX07XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGVlcENsb25lKGZpbHRlci5jcml0ZXJpYSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSBjcml0ZXJpYSBmaWVsZHNcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZWNvcmQgdG8gdXNlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNlYXJjaEZpZWxkcyB0byB1c2VcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgaW5pdENyaXRlcmlhRmllbGRzKHJlY29yZDogU2F2ZWRGaWx0ZXIsIHNlYXJjaEZpZWxkczogU2VhcmNoTWV0YUZpZWxkTWFwKTogdm9pZCB7XG5cbiAgICAgICAgcmVjb3JkLmNyaXRlcmlhRmllbGRzID0gcmVjb3JkLmNyaXRlcmlhRmllbGRzIHx8IHt9IGFzIEZpZWxkTWFwO1xuICAgICAgICBpZiAoIXJlY29yZC5jcml0ZXJpYUZvcm1Hcm91cCkge1xuICAgICAgICAgICAgcmVjb3JkLmNyaXRlcmlhRm9ybUdyb3VwID0gbmV3IFVudHlwZWRGb3JtR3JvdXAoe30pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFzZWFyY2hGaWVsZHMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIE9iamVjdC5rZXlzKHNlYXJjaEZpZWxkcykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgdGhpcy5idWlsZEZpZWxkKHJlY29yZCwgc2VhcmNoRmllbGRzW2tleV0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCdWlsZCBmaWx0ZXIgZmllbGQgYWNjb3JkaW5nIHRvIEZpZWxkIGludGVyZmFjZVxuICAgICAqXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlY29yZCBTYXZlZEZpbHRlclxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBmaWVsZE1ldGEgdG8gdXNlXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGJ1aWxkRmllbGQocmVjb3JkOiBTYXZlZEZpbHRlciwgZmllbGRNZXRhOiBTZWFyY2hNZXRhRmllbGQpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZmllbGROYW1lID0gZmllbGRNZXRhLm5hbWU7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBmaWVsZE1ldGEudHlwZTtcblxuICAgICAgICBjb25zdCBkZWZpbml0aW9uID0ge1xuICAgICAgICAgICAgbmFtZTogZmllbGRNZXRhLm5hbWUsXG4gICAgICAgICAgICBsYWJlbDogZmllbGRNZXRhLmxhYmVsLFxuICAgICAgICAgICAgdmFyZGVmQmFzZWQ6IGZpZWxkTWV0YT8udmFyZGVmQmFzZWQgPz8gZmFsc2UsXG4gICAgICAgICAgICByZWFkb25seTogZmllbGRNZXRhPy5yZWFkb25seSA/PyBmYWxzZSxcbiAgICAgICAgICAgIGRpc3BsYXk6IGZpZWxkTWV0YT8uZGlzcGxheSA/PyAnZGVmYXVsdCcsXG4gICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgZmllbGREZWZpbml0aW9uOiB7fVxuICAgICAgICB9IGFzIFZpZXdGaWVsZERlZmluaXRpb247XG5cbiAgICAgICAgaWYgKGZpZWxkTWV0YS5maWVsZERlZmluaXRpb24pIHtcbiAgICAgICAgICAgIGRlZmluaXRpb24uZmllbGREZWZpbml0aW9uID0gZmllbGRNZXRhLmZpZWxkRGVmaW5pdGlvbjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlID09PSAnYm9vbCcgfHwgdHlwZSA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICAgICAgICBkZWZpbml0aW9uLmZpZWxkRGVmaW5pdGlvbi5vcHRpb25zID0gJ2RvbV9pbnRfYm9vbCc7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmZpZWxkTWFuYWdlci5hZGRGaWx0ZXJGaWVsZChyZWNvcmQsIGRlZmluaXRpb24sIHRoaXMubGFuZ3VhZ2UpO1xuXG4gICAgfVxufVxuIl19
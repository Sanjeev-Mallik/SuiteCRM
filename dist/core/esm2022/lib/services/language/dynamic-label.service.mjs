/**
 * SuiteCRM is a customer relationship management program developed by SalesAgility Ltd.
 * Copyright (C) 2021 SalesAgility Ltd.
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Affero General Public License version 3 as published by the
 * Free Software Foundation with the addition of the following permission added
 * to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK
 * IN WHICH THE COPYRIGHT IS OWNED BY SALESAGILITY, SALESAGILITY DISCLAIMS THE
 * WARRANTY OF NON INFRINGEMENT OF THIRD PARTY RIGHTS.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * In accordance with Section 7(b) of the GNU Affero General Public License
 * version 3, these Appropriate Legal Notices must retain the display of the
 * "Supercharged by SuiteCRM" logo. If the display of the logos is not reasonably
 * feasible for technical reasons, the Appropriate Legal Notices must display
 * the words "Supercharged by SuiteCRM".
 */
import { Injectable } from '@angular/core';
import { DataTypeFormatter } from '../formatters/data-type.formatter.service';
import { isVoid } from '../../common/utils/value-utils';
import { LanguageStore } from '../../store/language/language.store';
import get from 'lodash-es/get';
import { SystemConfigStore } from '../../store/system-config/system-config.store';
import { UserPreferenceStore } from '../../store/user-preference/user-preference.store';
import * as i0 from "@angular/core";
import * as i1 from "../formatters/data-type.formatter.service";
import * as i2 from "../../store/language/language.store";
import * as i3 from "../../store/system-config/system-config.store";
import * as i4 from "../../store/user-preference/user-preference.store";
export class DynamicLabelService {
    constructor(typeFormatter, language, configs, preferences) {
        this.typeFormatter = typeFormatter;
        this.language = language;
        this.configs = configs;
        this.preferences = preferences;
        this.valuePipes = {};
        this.fieldPipes = {};
        this.valuePipes.int = (value) => this.valueTypeFormat('int', value);
        this.valuePipes.float = (value) => this.valueTypeFormat('float', value);
        this.valuePipes.date = (value) => this.valueTypeFormat('date', value);
        this.valuePipes.datetime = (value) => this.valueTypeFormat('datetime', value);
        this.valuePipes.currency = (value) => this.valueTypeFormat('currency', value);
        this.valuePipes.enum = (value, filterArguments = []) => this.enumFormat(value, filterArguments);
        this.fieldPipes.int = (value) => this.fieldTypeFormat('int', value);
        this.fieldPipes.float = (value) => this.fieldTypeFormat('float', value);
        this.fieldPipes.date = (value) => this.fieldTypeFormat('date', value);
        this.fieldPipes.datetime = (value) => this.fieldTypeFormat('datetime', value);
        this.fieldPipes.currency = (value) => this.fieldTypeFormat('currency', value);
        this.fieldPipes.phone = (value) => this.fieldTypeFormat('phone', value);
        this.fieldPipes.enum = (value) => this.enumFieldFormat(value);
        this.fieldPipes.dynamicenum = (value) => this.enumFieldFormat(value);
        this.fieldPipes.multienum = (value) => this.multiEnumFormat(value);
    }
    addValuePipe(name, processor) {
        this.valuePipes[name] = processor;
    }
    addFieldPipe(name, processor) {
        this.fieldPipes[name] = processor;
    }
    parse(template, context, fields) {
        if (!template) {
            return template;
        }
        const regex = /({{[\s\S]+?}})/g;
        const matches = template.match(regex);
        if (!matches || matches.length < 1) {
            return template;
        }
        let parsedTemplate = template;
        const module = (context && context.module) || '';
        matches.forEach((regexMatch) => {
            if (!parsedTemplate.includes(regexMatch)) {
                return;
            }
            let filter = '';
            let filterArguments = [];
            let value = '';
            let source = 'context';
            let parts = [];
            let variableName = '' + regexMatch;
            variableName = variableName.replace('{{', '');
            variableName = variableName.replace('}}', '');
            variableName = variableName.trim();
            let path = variableName;
            if (variableName.includes('|')) {
                const [name, pipe, ...others] = variableName.split('|');
                filter = pipe.trim();
                if (pipe.trim().includes(':')) {
                    let [filterType, ...filterArgs] = pipe.trim().split(':');
                    filter = filterType.trim();
                    filterArguments = filterArgs;
                }
                variableName = name.trim();
                path = name.trim();
            }
            if (variableName.includes('.')) {
                parts = variableName.split('.');
                source = parts[0];
                variableName = parts[1];
            }
            let sourceValues = context;
            if (source === 'fields') {
                sourceValues = fields;
            }
            if (source === 'fields') {
                if (!sourceValues || !(variableName in sourceValues)) {
                    parsedTemplate = parsedTemplate.replace(regexMatch, value);
                    return;
                }
                const field = fields[variableName];
                if (!field) {
                    parsedTemplate = parsedTemplate.replace(regexMatch, '');
                    return;
                }
                if (parts[2] && parts[2] === 'value' && field.type in this.fieldPipes) {
                    value = this.fieldPipes[field.type](field);
                    parsedTemplate = parsedTemplate.replace(regexMatch, value);
                    return;
                }
                if (parts[2] && parts[2] === 'label') {
                    value = this.getFieldLabel(field.labelKey, module);
                    parsedTemplate = parsedTemplate.replace(regexMatch, value);
                    return;
                }
                value = get({ fields }, path, '');
                parsedTemplate = parsedTemplate.replace(regexMatch, value);
                return;
            }
            if (source === 'config') {
                parsedTemplate = this.parseObjectContext(variableName, parsedTemplate, regexMatch, filter, filterArguments, (key) => {
                    return this.configs.getConfigValue(key);
                });
                return;
            }
            if (source === 'preferences') {
                parsedTemplate = this.parseObjectContext(variableName, parsedTemplate, regexMatch, filter, filterArguments, (key) => {
                    return this.preferences.getUserPreference(key);
                });
                return;
            }
            if (!sourceValues || !(variableName in sourceValues)) {
                parsedTemplate = parsedTemplate.replace(regexMatch, value);
                return;
            }
            value = get({ context }, path, '');
            if (filter in this.valuePipes) {
                value = this.valuePipes[filter](value);
            }
            parsedTemplate = parsedTemplate.replace(regexMatch, value);
        });
        return parsedTemplate;
    }
    valueTypeFormat(type, value) {
        return this.typeFormatter.toUserFormat(type, value);
    }
    enumFormat(value, filterArguments) {
        const options = filterArguments[0] ?? '';
        if (!options || !value) {
            return '';
        }
        return this.language.getListLabel(options, value);
    }
    fieldTypeFormat(type, field) {
        return this.typeFormatter.toUserFormat(type, field.value);
    }
    enumFieldFormat(field) {
        if (isVoid(field.definition.options) || isVoid(field.value)) {
            return '';
        }
        return this.language.getListLabel(field.definition.options, field.value);
    }
    multiEnumFormat(field) {
        if (isVoid(field.definition.options) || isVoid(field.valueList) || field.valueList.length < 1) {
            return '';
        }
        const result = [];
        field.valueList.forEach(value => {
            if (isVoid(value)) {
                return;
            }
            result.push(this.language.getListLabel(field.definition.options, value));
        });
        return result.join(', ');
    }
    getFieldLabel(labelKey, module = '') {
        if (isVoid(labelKey)) {
            return '';
        }
        return this.language.getFieldLabel(labelKey, module);
    }
    parseObjectContext(variableName, parsedTemplate, regexMatch, filter, filterArguments, getter) {
        let entryKey = variableName;
        if (variableName.includes('.')) {
            let [key, ...others] = variableName.split('.');
            entryKey = key;
        }
        let value = getter(entryKey);
        if (variableName.includes('.') && typeof value === 'object') {
            value = get({ value }, variableName, '');
        }
        if (!value || typeof value === 'object') {
            return parsedTemplate.replace(regexMatch, '');
        }
        if (filter in this.valuePipes) {
            value = this.valuePipes[filter](value, filterArguments);
        }
        return parsedTemplate.replace(regexMatch, value);
    }
    static { this.ɵfac = function DynamicLabelService_Factory(__ngFactoryType__) { return new (__ngFactoryType__ || DynamicLabelService)(i0.ɵɵinject(i1.DataTypeFormatter), i0.ɵɵinject(i2.LanguageStore), i0.ɵɵinject(i3.SystemConfigStore), i0.ɵɵinject(i4.UserPreferenceStore)); }; }
    static { this.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: DynamicLabelService, factory: DynamicLabelService.ɵfac, providedIn: 'root' }); }
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(DynamicLabelService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], () => [{ type: i1.DataTypeFormatter }, { type: i2.LanguageStore }, { type: i3.SystemConfigStore }, { type: i4.UserPreferenceStore }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1sYWJlbC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vY29yZS9hcHAvY29yZS9zcmMvbGliL3NlcnZpY2VzL2xhbmd1YWdlL2R5bmFtaWMtbGFiZWwuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBd0JHO0FBRUgsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSwyQ0FBMkMsQ0FBQztBQUU1RSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFFdEQsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBQ2xFLE9BQU8sR0FBRyxNQUFNLGVBQWUsQ0FBQztBQUNoQyxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSwrQ0FBK0MsQ0FBQztBQUNoRixPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSxtREFBbUQsQ0FBQzs7Ozs7O0FBeUJ0RixNQUFNLE9BQU8sbUJBQW1CO0lBSTVCLFlBQ2MsYUFBZ0MsRUFDaEMsUUFBdUIsRUFDdkIsT0FBMEIsRUFDMUIsV0FBZ0M7UUFIaEMsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQ2hDLGFBQVEsR0FBUixRQUFRLENBQWU7UUFDdkIsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFDMUIsZ0JBQVcsR0FBWCxXQUFXLENBQXFCO1FBUHBDLGVBQVUsR0FBMkIsRUFBRSxDQUFDO1FBQ3hDLGVBQVUsR0FBMkIsRUFBRSxDQUFDO1FBUzlDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxHQUFHLENBQUMsS0FBYSxFQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNwRixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssR0FBRyxDQUFD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QztRQUMzQyxDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUN0QyxPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELENBQUM7UUFFRCxJQUFJLE1BQU0sSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDNUIsS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQzVELENBQUM7UUFFRCxPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3JELENBQUM7b0hBMVBRLG1CQUFtQjt1RUFBbkIsbUJBQW1CLFdBQW5CLG1CQUFtQixtQkFGaEIsTUFBTTs7aUZBRVQsbUJBQW1CO2NBSC9CLFVBQVU7ZUFBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU3VpdGVDUk0gaXMgYSBjdXN0b21lciByZWxhdGlvbnNoaXAgbWFuYWdlbWVudCBwcm9ncmFtIGRldmVsb3BlZCBieSBTYWxlc0FnaWxpdHkgTHRkLlxuICogQ29weXJpZ2h0IChDKSAyMDIxIFNhbGVzQWdpbGl0eSBMdGQuXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkgaXQgdW5kZXJcbiAqIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIHZlcnNpb24gMyBhcyBwdWJsaXNoZWQgYnkgdGhlXG4gKiBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24gd2l0aCB0aGUgYWRkaXRpb24gb2YgdGhlIGZvbGxvd2luZyBwZXJtaXNzaW9uIGFkZGVkXG4gKiB0byBTZWN0aW9uIDE1IGFzIHBlcm1pdHRlZCBpbiBTZWN0aW9uIDcoYSk6IEZPUiBBTlkgUEFSVCBPRiBUSEUgQ09WRVJFRCBXT1JLXG4gKiBJTiBXSElDSCBUSEUgQ09QWVJJR0hUIElTIE9XTkVEIEJZIFNBTEVTQUdJTElUWSwgU0FMRVNBR0lMSVRZIERJU0NMQUlNUyBUSEVcbiAqIFdBUlJBTlRZIE9GIE5PTiBJTkZSSU5HRU1FTlQgT0YgVEhJUkQgUEFSVFkgUklHSFRTLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLCBidXQgV0lUSE9VVFxuICogQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1NcbiAqIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmVcbiAqIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqXG4gKiBJbiBhY2NvcmRhbmNlIHdpdGggU2VjdGlvbiA3KGIpIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIHZlcnNpb24gMywgdGhlc2UgQXBwcm9wcmlhdGUgTGVnYWwgTm90aWNlcyBtdXN0IHJldGFpbiB0aGUgZGlzcGxheSBvZiB0aGVcbiAqIFwiU3VwZXJjaGFyZ2VkIGJ5IFN1aXRlQ1JNXCIgbG9nby4gSWYgdGhlIGRpc3BsYXkgb2YgdGhlIGxvZ29zIGlzIG5vdCByZWFzb25hYmx5XG4gKiBmZWFzaWJsZSBmb3IgdGVjaG5pY2FsIHJlYXNvbnMsIHRoZSBBcHByb3ByaWF0ZSBMZWdhbCBOb3RpY2VzIG11c3QgZGlzcGxheVxuICogdGhlIHdvcmRzIFwiU3VwZXJjaGFyZ2VkIGJ5IFN1aXRlQ1JNXCIuXG4gKi9cblxuaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7RGF0YVR5cGVGb3JtYXR0ZXJ9IGZyb20gJy4uL2Zvcm1hdHRlcnMvZGF0YS10eXBlLmZvcm1hdHRlci5zZXJ2aWNlJztcbmltcG9ydCB7U3RyaW5nTWFwfSBmcm9tICcuLi8uLi9jb21tb24vdHlwZXMvc3RyaW5nLW1hcCc7XG5pbXBvcnQge2lzVm9pZH0gZnJvbSAnLi4vLi4vY29tbW9uL3V0aWxzL3ZhbHVlLXV0aWxzJztcbmltcG9ydCB7RmllbGQsIEZpZWxkTWFwfSBmcm9tICcuLi8uLi9jb21tb24vcmVjb3JkL2ZpZWxkLm1vZGVsJztcbmltcG9ydCB7TGFuZ3VhZ2VTdG9yZX0gZnJvbSAnLi4vLi4vc3RvcmUvbGFuZ3VhZ2UvbGFuZ3VhZ2Uuc3RvcmUnO1xuaW1wb3J0IGdldCBmcm9tICdsb2Rhc2gtZXMvZ2V0JztcbmltcG9ydCB7U3lzdGVtQ29uZmlnU3RvcmV9IGZyb20gJy4uLy4uL3N0b3JlL3N5c3RlbS1jb25maWcvc3lzdGVtLWNvbmZpZy5zdG9yZSc7XG5pbXBvcnQge1VzZXJQcmVmZXJlbmNlU3RvcmV9IGZyb20gJy4uLy4uL3N0b3JlL3VzZXItcHJlZmVyZW5jZS91c2VyLXByZWZlcmVuY2Uuc3RvcmUnO1xuXG5cbmV4cG9ydCBkZWNsYXJlIHR5cGUgVGVtcGxhdGVWYWx1ZUZpbHRlciA9ICh2YWx1ZTogc3RyaW5nLCBmaWx0ZXJBcmd1bWVudHM/OiBzdHJpbmdbXSkgPT4gc3RyaW5nO1xuZXhwb3J0IGRlY2xhcmUgdHlwZSBUZW1wbGF0ZUZpZWxkRmlsdGVyID0gKHZhbHVlOiBGaWVsZCkgPT4gc3RyaW5nO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRlbXBsYXRlVmFsdWVGaWx0ZXJNYXAge1xuICAgIFtrZXk6IHN0cmluZ106IFRlbXBsYXRlVmFsdWVGaWx0ZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGVtcGxhdGVGaWVsZEZpbHRlck1hcCB7XG4gICAgW2tleTogc3RyaW5nXTogVGVtcGxhdGVGaWVsZEZpbHRlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbWljTGFiZWxTZXJ2aWNlSW50ZXJmYWNlIHtcbiAgICBhZGRWYWx1ZVBpcGUobmFtZTogc3RyaW5nLCBwcm9jZXNzb3I6IFRlbXBsYXRlVmFsdWVGaWx0ZXIpOiB2b2lkO1xuXG4gICAgYWRkRmllbGRQaXBlKG5hbWU6IHN0cmluZywgcHJvY2Vzc29yOiBUZW1wbGF0ZUZpZWxkRmlsdGVyKTogdm9pZDtcblxuICAgIHBhcnNlKHRlbXBsYXRlOiBzdHJpbmcsIGNvbnRleHQ6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0sIGZpZWxkczogRmllbGRNYXApOiBzdHJpbmc7XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgRHluYW1pY0xhYmVsU2VydmljZSBpbXBsZW1lbnRzIER5bmFtaWNMYWJlbFNlcnZpY2VJbnRlcmZhY2Uge1xuICAgIHByb3RlY3RlZCB2YWx1ZVBpcGVzOiBUZW1wbGF0ZVZhbHVlRmlsdGVyTWFwID0ge307XG4gICAgcHJvdGVjdGVkIGZpZWxkUGlwZXM6IFRlbXBsYXRlRmllbGRGaWx0ZXJNYXAgPSB7fTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcm90ZWN0ZWQgdHlwZUZvcm1hdHRlcjogRGF0YVR5cGVGb3JtYXR0ZXIsXG4gICAgICAgIHByb3RlY3RlZCBsYW5ndWFnZTogTGFuZ3VhZ2VTdG9yZSxcbiAgICAgICAgcHJvdGVjdGVkIGNvbmZpZ3M6IFN5c3RlbUNvbmZpZ1N0b3JlLFxuICAgICAgICBwcm90ZWN0ZWQgcHJlZmVyZW5jZXM6IFVzZXJQcmVmZXJlbmNlU3RvcmUsXG4gICAgKSB7XG5cbiAgICAgICAgdGhpcy52YWx1ZVBpcGVzLmludCA9ICh2YWx1ZTogc3RyaW5nKTogc3RyaW5nID0+IHRoaXMudmFsdWVUeXBlRm9ybWF0KCdpbnQnLCB2YWx1ZSk7XG4gICAgICAgIHRoaXMudmFsdWVQaXBlcy5mbG9hdCA9ICh2YWx1ZTogc3RyaW5nKTogc3RyaW5nID0+IHRoaXMudmFsdWVUeXBlRm9ybWF0KCdmbG9hdCcsIHZhbHVlKTtcbiAgICAgICAgdGhpcy52YWx1ZVBpcGVzLmRhdGUgPSAodmFsdWU6IHN0cmluZyk6IHN0cmluZyA9PiB0aGlzLnZhbHVlVHlwZUZvcm1hdCgnZGF0ZScsIHZhbHVlKTtcbiAgICAgICAgdGhpcy52YWx1ZVBpcGVzLmRhdGV0aW1lID0gKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcgPT4gdGhpcy52YWx1ZVR5cGVGb3JtYXQoJ2RhdGV0aW1lJywgdmFsdWUpO1xuICAgICAgICB0aGlzLnZhbHVlUGlwZXMuY3VycmVuY3kgPSAodmFsdWU6IHN0cmluZyk6IHN0cmluZyA9PiB0aGlzLnZhbHVlVHlwZUZvcm1hdCgnY3VycmVuY3knLCB2YWx1ZSk7XG4gICAgICAgIHRoaXMudmFsdWVQaXBlcy5lbnVtID0gKHZhbHVlOiBzdHJpbmcsIGZpbHRlckFyZ3VtZW50czogc3RyaW5nW10gPSBbXSk6IHN0cmluZyA9PiB0aGlzLmVudW1Gb3JtYXQodmFsdWUsIGZpbHRlckFyZ3VtZW50cyk7XG5cbiAgICAgICAgdGhpcy5maWVsZFBpcGVzLmludCA9ICh2YWx1ZTogRmllbGQpOiBzdHJpbmcgPT4gdGhpcy5maWVsZFR5cGVGb3JtYXQoJ2ludCcsIHZhbHVlKTtcbiAgICAgICAgdGhpcy5maWVsZFBpcGVzLmZsb2F0ID0gKHZhbHVlOiBGaWVsZCk6IHN0cmluZyA9PiB0aGlzLmZpZWxkVHlwZUZvcm1hdCgnZmxvYXQnLCB2YWx1ZSk7XG4gICAgICAgIHRoaXMuZmllbGRQaXBlcy5kYXRlID0gKHZhbHVlOiBGaWVsZCk6IHN0cmluZyA9PiB0aGlzLmZpZWxkVHlwZUZvcm1hdCgnZGF0ZScsIHZhbHVlKTtcbiAgICAgICAgdGhpcy5maWVsZFBpcGVzLmRhdGV0aW1lID0gKHZhbHVlOiBGaWVsZCk6IHN0cmluZyA9PiB0aGlzLmZpZWxkVHlwZUZvcm1hdCgnZGF0ZXRpbWUnLCB2YWx1ZSk7XG4gICAgICAgIHRoaXMuZmllbGRQaXBlcy5jdXJyZW5jeSA9ICh2YWx1ZTogRmllbGQpOiBzdHJpbmcgPT4gdGhpcy5maWVsZFR5cGVGb3JtYXQoJ2N1cnJlbmN5JywgdmFsdWUpO1xuICAgICAgICB0aGlzLmZpZWxkUGlwZXMucGhvbmUgPSAodmFsdWU6IEZpZWxkKTogc3RyaW5nID0+IHRoaXMuZmllbGRUeXBlRm9ybWF0KCdwaG9uZScsIHZhbHVlKTtcbiAgICAgICAgdGhpcy5maWVsZFBpcGVzLmVudW0gPSAodmFsdWU6IEZpZWxkKTogc3RyaW5nID0+IHRoaXMuZW51bUZpZWxkRm9ybWF0KHZhbHVlKTtcbiAgICAgICAgdGhpcy5maWVsZFBpcGVzLmR5bmFtaWNlbnVtID0gKHZhbHVlOiBGaWVsZCk6IHN0cmluZyA9PiB0aGlzLmVudW1GaWVsZEZvcm1hdCh2YWx1ZSk7XG4gICAgICAgIHRoaXMuZmllbGRQaXBlcy5tdWx0aWVudW0gPSAodmFsdWU6IEZpZWxkKTogc3RyaW5nID0+IHRoaXMubXVsdGlFbnVtRm9ybWF0KHZhbHVlKTtcbiAgICB9XG5cbiAgICBhZGRWYWx1ZVBpcGUobmFtZTogc3RyaW5nLCBwcm9jZXNzb3I6IFRlbXBsYXRlVmFsdWVGaWx0ZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy52YWx1ZVBpcGVzW25hbWVdID0gcHJvY2Vzc29yO1xuICAgIH1cblxuICAgIGFkZEZpZWxkUGlwZShuYW1lOiBzdHJpbmcsIHByb2Nlc3NvcjogVGVtcGxhdGVGaWVsZEZpbHRlcik6IHZvaWQge1xuICAgICAgICB0aGlzLmZpZWxkUGlwZXNbbmFtZV0gPSBwcm9jZXNzb3I7XG4gICAgfVxuXG4gICAgcGFyc2UodGVtcGxhdGU6IHN0cmluZywgY29udGV4dDogU3RyaW5nTWFwLCBmaWVsZHM6IEZpZWxkTWFwKTogc3RyaW5nIHtcblxuICAgICAgICBpZiAoIXRlbXBsYXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZWdleCA9IC8oe3tbXFxzXFxTXSs/fX0pL2c7XG5cbiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IHRlbXBsYXRlLm1hdGNoKHJlZ2V4KTtcblxuICAgICAgICBpZiAoIW1hdGNoZXMgfHwgbWF0Y2hlcy5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcGFyc2VkVGVtcGxhdGUgPSB0ZW1wbGF0ZTtcblxuICAgICAgICBjb25zdCBtb2R1bGUgPSAoY29udGV4dCAmJiBjb250ZXh0Lm1vZHVsZSkgfHwgJyc7XG5cbiAgICAgICAgbWF0Y2hlcy5mb3JFYWNoKChyZWdleE1hdGNoKSA9PiB7XG5cbiAgICAgICAgICAgIGlmICghcGFyc2VkVGVtcGxhdGUuaW5jbHVkZXMocmVnZXhNYXRjaCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBmaWx0ZXIgPSAnJztcbiAgICAgICAgICAgIGxldCBmaWx0ZXJBcmd1bWVudHMgPSBbXTtcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9ICcnO1xuICAgICAgICAgICAgbGV0IHNvdXJjZSA9ICdjb250ZXh0JztcbiAgICAgICAgICAgIGxldCBwYXJ0cyA9IFtdO1xuXG4gICAgICAgICAgICBsZXQgdmFyaWFibGVOYW1lID0gJycgKyByZWdleE1hdGNoO1xuICAgICAgICAgICAgdmFyaWFibGVOYW1lID0gdmFyaWFibGVOYW1lLnJlcGxhY2UoJ3t7JywgJycpO1xuICAgICAgICAgICAgdmFyaWFibGVOYW1lID0gdmFyaWFibGVOYW1lLnJlcGxhY2UoJ319JywgJycpO1xuICAgICAgICAgICAgdmFyaWFibGVOYW1lID0gdmFyaWFibGVOYW1lLnRyaW0oKTtcblxuICAgICAgICAgICAgbGV0IHBhdGggPSB2YXJpYWJsZU5hbWU7XG5cbiAgICAgICAgICAgIGlmICh2YXJpYWJsZU5hbWUuaW5jbHVkZXMoJ3wnKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IFtuYW1lLCBwaXBlLCAuLi5vdGhlcnNdID0gdmFyaWFibGVOYW1lLnNwbGl0KCd8Jyk7XG4gICAgICAgICAgICAgICAgZmlsdGVyID0gcGlwZS50cmltKCk7XG5cbiAgICAgICAgICAgICAgICBpZiAocGlwZS50cmltKCkuaW5jbHVkZXMoJzonKSkge1xuICAgICAgICAgICAgICAgICAgICBsZXRbZmlsdGVyVHlwZSwgLi4uZmlsdGVyQXJnc10gPSBwaXBlLnRyaW0oKS5zcGxpdCgnOicpO1xuICAgICAgICAgICAgICAgICAgICBmaWx0ZXIgPSBmaWx0ZXJUeXBlLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyQXJndW1lbnRzID0gZmlsdGVyQXJncztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB2YXJpYWJsZU5hbWUgPSBuYW1lLnRyaW0oKTtcbiAgICAgICAgICAgICAgICBwYXRoID0gbmFtZS50cmltKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh2YXJpYWJsZU5hbWUuaW5jbHVkZXMoJy4nKSkge1xuICAgICAgICAgICAgICAgIHBhcnRzID0gdmFyaWFibGVOYW1lLnNwbGl0KCcuJyk7XG4gICAgICAgICAgICAgICAgc291cmNlID0gcGFydHNbMF07XG4gICAgICAgICAgICAgICAgdmFyaWFibGVOYW1lID0gcGFydHNbMV07XG4gICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgbGV0IHNvdXJjZVZhbHVlczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBGaWVsZCB9ID0gY29udGV4dDtcbiAgICAgICAgICAgIGlmIChzb3VyY2UgPT09ICdmaWVsZHMnKSB7XG4gICAgICAgICAgICAgICAgc291cmNlVmFsdWVzID0gZmllbGRzO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoc291cmNlID09PSAnZmllbGRzJykge1xuXG4gICAgICAgICAgICAgICAgaWYgKCFzb3VyY2VWYWx1ZXMgfHwgISh2YXJpYWJsZU5hbWUgaW4gc291cmNlVmFsdWVzKSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJzZWRUZW1wbGF0ZSA9IHBhcnNlZFRlbXBsYXRlLnJlcGxhY2UocmVnZXhNYXRjaCwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgZmllbGQgPSBmaWVsZHNbdmFyaWFibGVOYW1lXTtcblxuICAgICAgICAgICAgICAgIGlmICghZmllbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VkVGVtcGxhdGUgPSBwYXJzZWRUZW1wbGF0ZS5yZXBsYWNlKHJlZ2V4TWF0Y2gsICcnKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChwYXJ0c1syXSAmJiBwYXJ0c1syXSA9PT0gJ3ZhbHVlJyAmJiBmaWVsZC50eXBlIGluIHRoaXMuZmllbGRQaXBlcykge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZmllbGRQaXBlc1tmaWVsZC50eXBlXShmaWVsZCk7XG4gICAgICAgICAgICAgICAgICAgIHBhcnNlZFRlbXBsYXRlID0gcGFyc2VkVGVtcGxhdGUucmVwbGFjZShyZWdleE1hdGNoLCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAocGFydHNbMl0gJiYgcGFydHNbMl0gPT09ICdsYWJlbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmdldEZpZWxkTGFiZWwoZmllbGQubGFiZWxLZXksIG1vZHVsZSk7XG4gICAgICAgICAgICAgICAgICAgIHBhcnNlZFRlbXBsYXRlID0gcGFyc2VkVGVtcGxhdGUucmVwbGFjZShyZWdleE1hdGNoLCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGdldCh7ZmllbGRzfSwgcGF0aCwgJycpO1xuXG4gICAgICAgICAgICAgICAgcGFyc2VkVGVtcGxhdGUgPSBwYXJzZWRUZW1wbGF0ZS5yZXBsYWNlKHJlZ2V4TWF0Y2gsIHZhbHVlKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChzb3VyY2UgPT09ICdjb25maWcnKSB7XG4gICAgICAgICAgICAgICAgcGFyc2VkVGVtcGxhdGUgPSB0aGlzLnBhcnNlT2JqZWN0Q29udGV4dChcbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICBwYXJzZWRUZW1wbGF0ZSxcbiAgICAgICAgICAgICAgICAgICAgcmVnZXhNYXRjaCxcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyLFxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJBcmd1bWVudHMsXG4gICAgICAgICAgICAgICAgICAgIChrZXk6IHN0cmluZyk6IGFueSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25maWdzLmdldENvbmZpZ1ZhbHVlKGtleSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gJ3ByZWZlcmVuY2VzJykge1xuICAgICAgICAgICAgICAgIHBhcnNlZFRlbXBsYXRlID0gdGhpcy5wYXJzZU9iamVjdENvbnRleHQoXG4gICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VkVGVtcGxhdGUsXG4gICAgICAgICAgICAgICAgICAgIHJlZ2V4TWF0Y2gsXG4gICAgICAgICAgICAgICAgICAgIGZpbHRlcixcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyQXJndW1lbnRzLFxuICAgICAgICAgICAgICAgICAgICAoa2V5OiBzdHJpbmcpOiBhbnkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJlZmVyZW5jZXMuZ2V0VXNlclByZWZlcmVuY2Uoa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIXNvdXJjZVZhbHVlcyB8fCAhKHZhcmlhYmxlTmFtZSBpbiBzb3VyY2VWYWx1ZXMpKSB7XG4gICAgICAgICAgICAgICAgcGFyc2VkVGVtcGxhdGUgPSBwYXJzZWRUZW1wbGF0ZS5yZXBsYWNlKHJlZ2V4TWF0Y2gsIHZhbHVlKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhbHVlID0gZ2V0KHtjb250ZXh0fSwgcGF0aCwgJycpO1xuXG4gICAgICAgICAgICBpZiAoZmlsdGVyIGluIHRoaXMudmFsdWVQaXBlcykge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy52YWx1ZVBpcGVzW2ZpbHRlcl0odmFsdWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBwYXJzZWRUZW1wbGF0ZSA9IHBhcnNlZFRlbXBsYXRlLnJlcGxhY2UocmVnZXhNYXRjaCwgdmFsdWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcGFyc2VkVGVtcGxhdGU7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHZhbHVlVHlwZUZvcm1hdCh0eXBlOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy50eXBlRm9ybWF0dGVyLnRvVXNlckZvcm1hdCh0eXBlLCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGVudW1Gb3JtYXQodmFsdWU6IHN0cmluZywgZmlsdGVyQXJndW1lbnRzPzogc3RyaW5nW10pOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBvcHRpb25zID0gZmlsdGVyQXJndW1lbnRzWzBdID8/ICcnO1xuICAgICAgICBpZiAoIW9wdGlvbnMgfHwgIXZhbHVlKSB7XG4gICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5sYW5ndWFnZS5nZXRMaXN0TGFiZWwob3B0aW9ucywgdmFsdWUpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBmaWVsZFR5cGVGb3JtYXQodHlwZTogc3RyaW5nLCBmaWVsZDogRmllbGQpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy50eXBlRm9ybWF0dGVyLnRvVXNlckZvcm1hdCh0eXBlLCBmaWVsZC52YWx1ZSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGVudW1GaWVsZEZvcm1hdChmaWVsZDogRmllbGQpOiBzdHJpbmcge1xuICAgICAgICBpZiAoaXNWb2lkKGZpZWxkLmRlZmluaXRpb24ub3B0aW9ucykgfHwgaXNWb2lkKGZpZWxkLnZhbHVlKSkge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMubGFuZ3VhZ2UuZ2V0TGlzdExhYmVsKGZpZWxkLmRlZmluaXRpb24ub3B0aW9ucywgZmllbGQudmFsdWUpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBtdWx0aUVudW1Gb3JtYXQoZmllbGQ6IEZpZWxkKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKGlzVm9pZChmaWVsZC5kZWZpbml0aW9uLm9wdGlvbnMpIHx8IGlzVm9pZChmaWVsZC52YWx1ZUxpc3QpIHx8IGZpZWxkLnZhbHVlTGlzdC5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQ6IHN0cmluZ1tdID0gW107XG5cbiAgICAgICAgZmllbGQudmFsdWVMaXN0LmZvckVhY2godmFsdWUgPT4ge1xuICAgICAgICAgICAgaWYgKGlzVm9pZCh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHRoaXMubGFuZ3VhZ2UuZ2V0TGlzdExhYmVsKGZpZWxkLmRlZmluaXRpb24ub3B0aW9ucywgdmFsdWUpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdC5qb2luKCcsICcpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRGaWVsZExhYmVsKGxhYmVsS2V5OiBzdHJpbmcsIG1vZHVsZSA9ICcnKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKGlzVm9pZChsYWJlbEtleSkpIHtcbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmxhbmd1YWdlLmdldEZpZWxkTGFiZWwobGFiZWxLZXksIG1vZHVsZSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHBhcnNlT2JqZWN0Q29udGV4dCh2YXJpYWJsZU5hbWU6IHN0cmluZywgcGFyc2VkVGVtcGxhdGU6IHN0cmluZywgcmVnZXhNYXRjaDogc3RyaW5nLCBmaWx0ZXI6IHN0cmluZywgZmlsdGVyQXJndW1lbnRzOiBzdHJpbmdbXSwgZ2V0dGVyOiAoa2V5OiBzdHJpbmcpID0+IGFueSk6IHN0cmluZyB7XG4gICAgICAgIGxldCBlbnRyeUtleSA9IHZhcmlhYmxlTmFtZTtcbiAgICAgICAgaWYgKHZhcmlhYmxlTmFtZS5pbmNsdWRlcygnLicpKSB7XG4gICAgICAgICAgICBsZXQgW2tleSwgLi4ub3RoZXJzXSA9IHZhcmlhYmxlTmFtZS5zcGxpdCgnLicpO1xuICAgICAgICAgICAgZW50cnlLZXkgPSBrZXk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdmFsdWUgPSBnZXR0ZXIoZW50cnlLZXkpO1xuXG4gICAgICAgIGlmICh2YXJpYWJsZU5hbWUuaW5jbHVkZXMoJy4nKSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IGdldCh7dmFsdWV9LCB2YXJpYWJsZU5hbWUsICcnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdmFsdWUgfHwgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgcmV0dXJuIHBhcnNlZFRlbXBsYXRlLnJlcGxhY2UocmVnZXhNYXRjaCwgJycpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZpbHRlciBpbiB0aGlzLnZhbHVlUGlwZXMpIHtcbiAgICAgICAgICAgIHZhbHVlID0gdGhpcy52YWx1ZVBpcGVzW2ZpbHRlcl0odmFsdWUsIGZpbHRlckFyZ3VtZW50cyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcGFyc2VkVGVtcGxhdGUucmVwbGFjZShyZWdleE1hdGNoLCB2YWx1ZSk7XG4gICAgfVxufVxuIl19
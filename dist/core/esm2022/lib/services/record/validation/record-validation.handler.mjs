import { Injectable } from "@angular/core";
import * as i0 from "@angular/core";
export class RecordValidationHandler {
    /**
     * Initialize Record Validators
     * @param record
     */
    initValidators(record) {
        if (!record) {
            return;
        }
        record?.formGroup?.clearValidators();
        const fields = record?.fields ?? {};
        Object.keys(fields).forEach(fieldName => {
            const field = record.fields[fieldName];
            const formControl = field?.formControl ?? null;
            if (!formControl) {
                return;
            }
            this.initFieldValidators(field);
            this.initLineItemsValidators(field);
        });
    }
    /**
     * reset record field validators
     * @param record
     */
    resetValidators(record) {
        if (!record) {
            return;
        }
        record?.formGroup?.clearValidators();
        const fields = record?.fields ?? {};
        Object.keys(fields).forEach(fieldName => {
            const field = record.fields[fieldName];
            this.resetFieldValidators(field);
            this.resetLineItemsValidators(field);
        });
    }
    /**
     * Set field validators
     * @param field
     * @param validators
     * @param asyncValidators
     */
    setFormControlValidators(field, validators, asyncValidators) {
        if (!field?.formControl) {
            return;
        }
        if (validators?.length) {
            field.formControl.setValidators(validators);
        }
        if (asyncValidators?.length) {
            field.formControl.setAsyncValidators(asyncValidators);
        }
    }
    /**
     * Reset field validators
     * @param field
     */
    resetFormControlValidators(field) {
        if (!field?.formControl) {
            return;
        }
        field.formControl.clearValidators();
        field.formControl.clearAsyncValidators();
    }
    /**
     * Initialize Field validators
     * @param field
     */
    initFieldValidators(field) {
        this.resetFormControlValidators(field);
        this.setFormControlValidators(field, field?.validators ?? [], field?.asyncValidators ?? []);
        const fieldAttributes = field?.attributes ?? {};
        Object.keys(fieldAttributes).forEach(fieldAttributeName => {
            const fieldAttribute = fieldAttributes[fieldAttributeName];
            this.resetFormControlValidators(fieldAttribute);
            this.setFormControlValidators(fieldAttribute, fieldAttribute?.validators ?? [], fieldAttribute?.asyncValidators ?? []);
        });
    }
    /**
     * Initialize Field validators
     * @param field
     */
    resetFieldValidators(field) {
        this.resetFormControlValidators(field);
        const fieldAttributes = field?.attributes ?? {};
        Object.keys(fieldAttributes).forEach(fieldAttributeName => {
            const fieldAttribute = fieldAttributes[fieldAttributeName];
            this.resetFormControlValidators(fieldAttribute);
        });
    }
    /**
     * Initialize Line Items validators
     * @param field
     */
    initLineItemsValidators(field) {
        if (!field?.itemFormArray) {
            return;
        }
        const itemFormArraySaveValidators = field?.itemFormArraySaveValidators ?? [];
        if (itemFormArraySaveValidators.length) {
            field.itemFormArray.clearValidators();
            field.itemFormArray.addValidators(itemFormArraySaveValidators);
        }
        const items = field?.items ?? [];
        items.forEach(item => {
            const itemFields = item?.fields ?? {};
            Object.keys(itemFields).forEach(itemFieldName => {
                const itemField = itemFields[itemFieldName];
                this.initFieldValidators(itemField);
            });
        });
    }
    /**
     * Initialize Line Items validators
     * @param field
     */
    resetLineItemsValidators(field) {
        if (!field?.itemFormArray) {
            return;
        }
        field.itemFormArray.clearValidators();
        const items = field?.items ?? [];
        items.forEach(item => {
            const itemFields = item?.fields ?? {};
            Object.keys(itemFields).forEach(itemFieldName => {
                const itemField = itemFields[itemFieldName];
                this.resetFieldValidators(field);
            });
        });
    }
    static { this.ɵfac = function RecordValidationHandler_Factory(__ngFactoryType__) { return new (__ngFactoryType__ || RecordValidationHandler)(); }; }
    static { this.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: RecordValidationHandler, factory: RecordValidationHandler.ɵfac, providedIn: 'root' }); }
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(RecordValidationHandler, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], null, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjb3JkLXZhbGlkYXRpb24uaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2NvcmUvYXBwL2NvcmUvc3JjL2xpYi9zZXJ2aWNlcy9yZWNvcmQvdmFsaWRhdGlvbi9yZWNvcmQtdmFsaWRhdGlvbi5oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQTBCQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDOztBQU96QyxNQUFNLE9BQU8sdUJBQXVCO0lBRWhDOzs7T0FHRztJQUNILGNBQWMsQ0FBQyxNQUFjO1FBQ3pCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNWLE9BQU87UUFDWCxDQUFDO1FBRUQsTUFBTSxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsQ0FBQztRQUVyQyxNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsTUFBTSxJQUFJLEVBQWMsQ0FBQztRQUNoRCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNwQyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sV0FBVyxHQUFHLEtBQUssRUFBRSxXQUFXLElBQUksSUFBSSxDQUFDO1lBQy9DLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDZixPQUFPO1lBQ1gsQ0FBQztZQUVELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVoQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFHeEMsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsZUFBZSxDQUFDLE1BQWM7UUFDMUIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1YsT0FBTztRQUNYLENBQUM7UUFFRCxNQUFNLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFB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QUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDckMsQ0FBQyxDQUFDLENBQUM7UUFFUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7d0hBM0tRLHVCQUF1Qjt1RUFBdkIsdUJBQXVCLFdBQXZCLHVCQUF1QixtQkFGcEIsTUFBTTs7aUZBRVQsdUJBQXVCO2NBSG5DLFVBQVU7ZUFBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU3VpdGVDUk0gaXMgYSBjdXN0b21lciByZWxhdGlvbnNoaXAgbWFuYWdlbWVudCBwcm9ncmFtIGRldmVsb3BlZCBieSBTYWxlc0FnaWxpdHkgTHRkLlxuICogQ29weXJpZ2h0IChDKSAyMDI0IFNhbGVzQWdpbGl0eSBMdGQuXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkgaXQgdW5kZXJcbiAqIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIHZlcnNpb24gMyBhcyBwdWJsaXNoZWQgYnkgdGhlXG4gKiBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24gd2l0aCB0aGUgYWRkaXRpb24gb2YgdGhlIGZvbGxvd2luZyBwZXJtaXNzaW9uIGFkZGVkXG4gKiB0byBTZWN0aW9uIDE1IGFzIHBlcm1pdHRlZCBpbiBTZWN0aW9uIDcoYSk6IEZPUiBBTlkgUEFSVCBPRiBUSEUgQ09WRVJFRCBXT1JLXG4gKiBJTiBXSElDSCBUSEUgQ09QWVJJR0hUIElTIE9XTkVEIEJZIFNBTEVTQUdJTElUWSwgU0FMRVNBR0lMSVRZIERJU0NMQUlNUyBUSEVcbiAqIFdBUlJBTlRZIE9GIE5PTiBJTkZSSU5HRU1FTlQgT0YgVEhJUkQgUEFSVFkgUklHSFRTLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLCBidXQgV0lUSE9VVFxuICogQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1NcbiAqIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmVcbiAqIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqXG4gKiBJbiBhY2NvcmRhbmNlIHdpdGggU2VjdGlvbiA3KGIpIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIHZlcnNpb24gMywgdGhlc2UgQXBwcm9wcmlhdGUgTGVnYWwgTm90aWNlcyBtdXN0IHJldGFpbiB0aGUgZGlzcGxheSBvZiB0aGVcbiAqIFwiU3VwZXJjaGFyZ2VkIGJ5IFN1aXRlQ1JNXCIgbG9nby4gSWYgdGhlIGRpc3BsYXkgb2YgdGhlIGxvZ29zIGlzIG5vdCByZWFzb25hYmx5XG4gKiBmZWFzaWJsZSBmb3IgdGVjaG5pY2FsIHJlYXNvbnMsIHRoZSBBcHByb3ByaWF0ZSBMZWdhbCBOb3RpY2VzIG11c3QgZGlzcGxheVxuICogdGhlIHdvcmRzIFwiU3VwZXJjaGFyZ2VkIGJ5IFN1aXRlQ1JNXCIuXG4gKi9cbmltcG9ydCB7QXN5bmNWYWxpZGF0b3JGbiwgVmFsaWRhdG9yRm59IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xuaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHtSZWNvcmR9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vcmVjb3JkL3JlY29yZC5tb2RlbFwiO1xuaW1wb3J0IHtGaWVsZCwgRmllbGRBdHRyaWJ1dGVNYXAsIEZpZWxkTWFwfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3JlY29yZC9maWVsZC5tb2RlbFwiO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFJlY29yZFZhbGlkYXRpb25IYW5kbGVyIHtcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgUmVjb3JkIFZhbGlkYXRvcnNcbiAgICAgKiBAcGFyYW0gcmVjb3JkXG4gICAgICovXG4gICAgaW5pdFZhbGlkYXRvcnMocmVjb3JkOiBSZWNvcmQpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFyZWNvcmQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlY29yZD8uZm9ybUdyb3VwPy5jbGVhclZhbGlkYXRvcnMoKTtcblxuICAgICAgICBjb25zdCBmaWVsZHMgPSByZWNvcmQ/LmZpZWxkcyA/PyB7fSBhcyBGaWVsZE1hcDtcbiAgICAgICAgT2JqZWN0LmtleXMoZmllbGRzKS5mb3JFYWNoKGZpZWxkTmFtZSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaWVsZCA9IHJlY29yZC5maWVsZHNbZmllbGROYW1lXTtcbiAgICAgICAgICAgIGNvbnN0IGZvcm1Db250cm9sID0gZmllbGQ/LmZvcm1Db250cm9sID8/IG51bGw7XG4gICAgICAgICAgICBpZiAoIWZvcm1Db250cm9sKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmluaXRGaWVsZFZhbGlkYXRvcnMoZmllbGQpO1xuXG4gICAgICAgICAgICB0aGlzLmluaXRMaW5lSXRlbXNWYWxpZGF0b3JzKGZpZWxkKTtcblxuXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogcmVzZXQgcmVjb3JkIGZpZWxkIHZhbGlkYXRvcnNcbiAgICAgKiBAcGFyYW0gcmVjb3JkXG4gICAgICovXG4gICAgcmVzZXRWYWxpZGF0b3JzKHJlY29yZDogUmVjb3JkKTogdm9pZCB7XG4gICAgICAgIGlmICghcmVjb3JkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICByZWNvcmQ/LmZvcm1Hcm91cD8uY2xlYXJWYWxpZGF0b3JzKCk7XG4gICAgICAgIGNvbnN0IGZpZWxkcyA9IHJlY29yZD8uZmllbGRzID8/IHt9IGFzIEZpZWxkTWFwO1xuXG4gICAgICAgIE9iamVjdC5rZXlzKGZpZWxkcykuZm9yRWFjaChmaWVsZE5hbWUgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmllbGQgPSByZWNvcmQuZmllbGRzW2ZpZWxkTmFtZV07XG5cbiAgICAgICAgICAgIHRoaXMucmVzZXRGaWVsZFZhbGlkYXRvcnMoZmllbGQpO1xuICAgICAgICAgICAgdGhpcy5yZXNldExpbmVJdGVtc1ZhbGlkYXRvcnMoZmllbGQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXQgZmllbGQgdmFsaWRhdG9yc1xuICAgICAqIEBwYXJhbSBmaWVsZFxuICAgICAqIEBwYXJhbSB2YWxpZGF0b3JzXG4gICAgICogQHBhcmFtIGFzeW5jVmFsaWRhdG9yc1xuICAgICAqL1xuICAgIHNldEZvcm1Db250cm9sVmFsaWRhdG9ycyhmaWVsZDogRmllbGQsIHZhbGlkYXRvcnM6IFZhbGlkYXRvckZuW10sIGFzeW5jVmFsaWRhdG9yczogQXN5bmNWYWxpZGF0b3JGbltdKTogdm9pZCB7XG4gICAgICAgIGlmICghZmllbGQ/LmZvcm1Db250cm9sKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodmFsaWRhdG9ycz8ubGVuZ3RoKSB7XG4gICAgICAgICAgICBmaWVsZC5mb3JtQ29udHJvbC5zZXRWYWxpZGF0b3JzKHZhbGlkYXRvcnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFzeW5jVmFsaWRhdG9ycz8ubGVuZ3RoKSB7XG4gICAgICAgICAgICBmaWVsZC5mb3JtQ29udHJvbC5zZXRBc3luY1ZhbGlkYXRvcnMoYXN5bmNWYWxpZGF0b3JzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlc2V0IGZpZWxkIHZhbGlkYXRvcnNcbiAgICAgKiBAcGFyYW0gZmllbGRcbiAgICAgKi9cbiAgICByZXNldEZvcm1Db250cm9sVmFsaWRhdG9ycyhmaWVsZDogRmllbGQpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFmaWVsZD8uZm9ybUNvbnRyb2wpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGZpZWxkLmZvcm1Db250cm9sLmNsZWFyVmFsaWRhdG9ycygpO1xuICAgICAgICBmaWVsZC5mb3JtQ29udHJvbC5jbGVhckFzeW5jVmFsaWRhdG9ycygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgRmllbGQgdmFsaWRhdG9yc1xuICAgICAqIEBwYXJhbSBmaWVsZFxuICAgICAqL1xuICAgIGluaXRGaWVsZFZhbGlkYXRvcnMoZmllbGQ6IEZpZWxkKTogdm9pZCB7XG4gICAgICAgIHRoaXMucmVzZXRGb3JtQ29udHJvbFZhbGlkYXRvcnMoZmllbGQpO1xuXG4gICAgICAgIHRoaXMuc2V0Rm9ybUNvbnRyb2xWYWxpZGF0b3JzKGZpZWxkLCBmaWVsZD8udmFsaWRhdG9ycyA/PyBbXSwgZmllbGQ/LmFzeW5jVmFsaWRhdG9ycyA/PyBbXSk7XG5cbiAgICAgICAgY29uc3QgZmllbGRBdHRyaWJ1dGVzID0gZmllbGQ/LmF0dHJpYnV0ZXMgPz8ge30gYXMgRmllbGRBdHRyaWJ1dGVNYXA7XG5cbiAgICAgICAgT2JqZWN0LmtleXMoZmllbGRBdHRyaWJ1dGVzKS5mb3JFYWNoKGZpZWxkQXR0cmlidXRlTmFtZSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaWVsZEF0dHJpYnV0ZSA9IGZpZWxkQXR0cmlidXRlc1tmaWVsZEF0dHJpYnV0ZU5hbWVdO1xuICAgICAgICAgICAgdGhpcy5yZXNldEZvcm1Db250cm9sVmFsaWRhdG9ycyhmaWVsZEF0dHJpYnV0ZSk7XG5cbiAgICAgICAgICAgIHRoaXMuc2V0Rm9ybUNvbnRyb2xWYWxpZGF0b3JzKGZpZWxkQXR0cmlidXRlLCBmaWVsZEF0dHJpYnV0ZT8udmFsaWRhdG9ycyA/PyBbXSwgZmllbGRBdHRyaWJ1dGU/LmFzeW5jVmFsaWRhdG9ycyA/PyBbXSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgRmllbGQgdmFsaWRhdG9yc1xuICAgICAqIEBwYXJhbSBmaWVsZFxuICAgICAqL1xuICAgIHJlc2V0RmllbGRWYWxpZGF0b3JzKGZpZWxkOiBGaWVsZCk6IHZvaWQge1xuXG4gICAgICAgIHRoaXMucmVzZXRGb3JtQ29udHJvbFZhbGlkYXRvcnMoZmllbGQpO1xuXG4gICAgICAgIGNvbnN0IGZpZWxkQXR0cmlidXRlcyA9IGZpZWxkPy5hdHRyaWJ1dGVzID8/IHt9IGFzIEZpZWxkQXR0cmlidXRlTWFwO1xuXG4gICAgICAgIE9iamVjdC5rZXlzKGZpZWxkQXR0cmlidXRlcykuZm9yRWFjaChmaWVsZEF0dHJpYnV0ZU5hbWUgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmllbGRBdHRyaWJ1dGUgPSBmaWVsZEF0dHJpYnV0ZXNbZmllbGRBdHRyaWJ1dGVOYW1lXTtcbiAgICAgICAgICAgIHRoaXMucmVzZXRGb3JtQ29udHJvbFZhbGlkYXRvcnMoZmllbGRBdHRyaWJ1dGUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplIExpbmUgSXRlbXMgdmFsaWRhdG9yc1xuICAgICAqIEBwYXJhbSBmaWVsZFxuICAgICAqL1xuICAgIGluaXRMaW5lSXRlbXNWYWxpZGF0b3JzKGZpZWxkOiBGaWVsZCk6IHZvaWQge1xuICAgICAgICBpZiAoIWZpZWxkPy5pdGVtRm9ybUFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBpdGVtRm9ybUFycmF5U2F2ZVZhbGlkYXRvcnMgPSBmaWVsZD8uaXRlbUZvcm1BcnJheVNhdmVWYWxpZGF0b3JzID8/IFtdO1xuXG4gICAgICAgIGlmIChpdGVtRm9ybUFycmF5U2F2ZVZhbGlkYXRvcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICBmaWVsZC5pdGVtRm9ybUFycmF5LmNsZWFyVmFsaWRhdG9ycygpXG4gICAgICAgICAgICBmaWVsZC5pdGVtRm9ybUFycmF5LmFkZFZhbGlkYXRvcnMoaXRlbUZvcm1BcnJheVNhdmVWYWxpZGF0b3JzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gZmllbGQ/Lml0ZW1zID8/IFtdO1xuICAgICAgICBpdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBpdGVtRmllbGRzID0gaXRlbT8uZmllbGRzID8/IHt9IGFzIEZpZWxkTWFwO1xuXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhpdGVtRmllbGRzKS5mb3JFYWNoKGl0ZW1GaWVsZE5hbWUgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1GaWVsZCA9IGl0ZW1GaWVsZHNbaXRlbUZpZWxkTmFtZV07XG5cbiAgICAgICAgICAgICAgICB0aGlzLmluaXRGaWVsZFZhbGlkYXRvcnMoaXRlbUZpZWxkKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgTGluZSBJdGVtcyB2YWxpZGF0b3JzXG4gICAgICogQHBhcmFtIGZpZWxkXG4gICAgICovXG4gICAgcmVzZXRMaW5lSXRlbXNWYWxpZGF0b3JzKGZpZWxkOiBGaWVsZCk6IHZvaWQge1xuICAgICAgICBpZiAoIWZpZWxkPy5pdGVtRm9ybUFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBmaWVsZC5pdGVtRm9ybUFycmF5LmNsZWFyVmFsaWRhdG9ycygpXG5cbiAgICAgICAgY29uc3QgaXRlbXMgPSBmaWVsZD8uaXRlbXMgPz8gW107XG4gICAgICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGl0ZW1GaWVsZHMgPSBpdGVtPy5maWVsZHMgPz8ge30gYXMgRmllbGRNYXA7XG5cbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGl0ZW1GaWVsZHMpLmZvckVhY2goaXRlbUZpZWxkTmFtZSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaXRlbUZpZWxkID0gaXRlbUZpZWxkc1tpdGVtRmllbGROYW1lXTtcblxuICAgICAgICAgICAgICAgIHRoaXMucmVzZXRGaWVsZFZhbGlkYXRvcnMoZmllbGQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19